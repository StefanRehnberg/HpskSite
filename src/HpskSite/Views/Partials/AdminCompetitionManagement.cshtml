@*
 * Admin Competition Management Partial View
 * Integrated competition management within the admin page
*@
@using System.Linq;
@using System;
@inject Umbraco.Cms.Core.Security.IMemberManager MemberManager
@{
    // Get competition ID from query string
    var competitionIdStr = Context.Request.Query["competitionId"].FirstOrDefault();
    int competitionId = 0;
    int.TryParse(competitionIdStr, out competitionId);

    // Find the competition content to get properties
    IPublishedContent? competition = null;
    if (competitionId > 0)
    {
        var root = Model.Root();
        competition = root.DescendantsOrSelf()
                         .FirstOrDefault((Func<IPublishedContent, bool>)(x => x.ContentType.Alias == "competition" && x.Id == competitionId));
    }

    // Pass competition properties to ViewData for partial views
    if (competition != null)
    {
        ViewData["NumberOfSeriesOrStations"] = competition.Value<int>("numberOfSeriesOrStations");
    }

    // Simplified approach - just check if user is logged in
    var currentMember = await MemberManager.GetCurrentMemberAsync();
    bool canManageCompetition = currentMember != null;
}

@* Check if user is logged in *@
@if (!canManageCompetition)
{
    <div class="alert alert-warning">
        <h4>Access Denied</h4>
        <p>You must be logged in to access competition management.</p>
    </div>
    return;
}

<!-- Competition Management Interface -->
<div class="competition-management-admin" data-competition-id="@competitionId">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4>
                <i class="bi bi-gear me-2"></i>Competition Management
            </h4>
            <p class="text-muted mb-0">Competition ID: @competitionId</p>
        </div>
        <div>
            <button class="btn btn-primary" onclick="refreshCompetitionData()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>

    @* Anti-forgery token for AJAX requests *@
    @Html.AntiForgeryToken()

    <!-- Sub-navigation tabs for competition management -->
    <ul class="nav nav-pills" id="compManagementTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="comp-overview-tab" data-bs-toggle="pill" data-bs-target="#comp-overview" type="button" role="tab">
                <i class="bi bi-info-circle me-1"></i>Overview
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="comp-registrations-tab" data-bs-toggle="pill" data-bs-target="#comp-registrations" type="button" role="tab">
                <i class="bi bi-people me-1"></i>Registrations
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="comp-startlists-tab" data-bs-toggle="pill" data-bs-target="#comp-startlists" type="button" role="tab">
                <i class="bi bi-list-ol me-1"></i>Start Lists
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="comp-results-tab" data-bs-toggle="pill" data-bs-target="#comp-results" type="button" role="tab">
                <i class="bi bi-trophy me-1"></i>Results
            </button>
        </li>
    </ul>

    <!-- Tab content -->
    <div class="tab-content" id="compManagementTabContent">
        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="comp-overview" role="tabpanel">
            <div class="mt-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-info-circle me-2"></i>Competition Information</h5>
                    </div>
                    <div class="card-body">
                        <p>Competition management tools will be available here.</p>
                        <p><strong>Competition ID:</strong> @competitionId</p>
                        <p><strong>Current User:</strong> @(currentMember?.Name ?? "Unknown")</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Registrations Tab -->
        <div class="tab-pane fade" id="comp-registrations" role="tabpanel">
            <div class="mt-3">
                @await Html.PartialAsync("CompetitionRegistrationManagement", new ViewDataDictionary(ViewData) { { "CompetitionId", competitionId } })
            </div>
        </div>

        <!-- Start Lists Tab -->
        <div class="tab-pane fade" id="comp-startlists" role="tabpanel">
            <div class="mt-3">
                @await Html.PartialAsync("CompetitionStartListManagement", new ViewDataDictionary(ViewData) { { "CompetitionId", competitionId } })
            </div>
        </div>

        <!-- Results Tab -->
        <div class="tab-pane fade" id="comp-results" role="tabpanel">
            <div class="mt-3">
                @await Html.PartialAsync("CompetitionResultsManagement", new ViewDataDictionary(ViewData) { { "CompetitionId", competitionId } })
            </div>
        </div>
    </div>
</div>

<script>
function refreshCompetitionData() {
    // Refresh the active tab
    var activeTab = document.querySelector('#compManagementTabs .nav-link.active');
    if (activeTab) {
        activeTab.click();
    }

    alert('Competition data refreshed');
}
</script>