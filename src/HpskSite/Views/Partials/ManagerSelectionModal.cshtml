@*
    Manager Selection Modal
    Dedicated modal for selecting competition managers with search functionality
    Improves UX when selecting from large member lists (100+ members)
*@

<!-- Manager Selection Modal -->
<div class="modal fade" id="managerSelectionModal" tabindex="-1" aria-labelledby="managerSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-fullscreen-sm-down">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="managerSelectionModalLabel">
                    <i class="bi bi-people"></i> Välj tävlingsledare
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Club Filter -->
                <div class="mb-3">
                    <label for="clubFilterSelect" class="form-label">Filtrera på klubb</label>
                    <select class="form-select" id="clubFilterSelect">
                        <option value="">Alla klubbar</option>
                        <!-- Populated dynamically -->
                    </select>
                </div>

                <!-- Search Box -->
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="managerSearchInput" placeholder="Sök medlem..." autocomplete="off">
                    </div>
                    <small class="text-muted">Sök på namn</small>
                </div>

                <!-- Selected Managers Section -->
                <div class="mb-3" id="selectedManagersSection" style="display: none;">
                    <label class="form-label fw-bold">Valda tävlingsledare (<span id="selectedManagerCount">0</span>)</label>
                    <div id="selectedManagersList" class="d-flex flex-wrap gap-2 p-2 bg-light rounded">
                        <!-- Selected managers appear here as removable badges -->
                    </div>
                </div>

                <!-- Available Members List -->
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        Tillgängliga medlemmar
                        <span class="badge bg-secondary" id="availableMemberCount">0</span>
                    </label>
                    <div id="managerMembersList" class="member-list border rounded p-2" style="max-height: 400px; overflow-y: auto;">
                        <!-- Loading spinner -->
                        <div class="text-center p-4" id="managerLoadingSpinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Laddar...</span>
                            </div>
                            <p class="mt-2 text-muted">Laddar medlemmar...</p>
                        </div>
                        <!-- Member list will be populated here -->
                    </div>
                </div>

                <!-- No Results Message -->
                <div id="noManagerResults" class="alert alert-info d-none">
                    <i class="bi bi-info-circle"></i> Inga medlemmar matchar din sökning.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                <button type="button" class="btn btn-primary" onclick="saveManagerSelection()">
                    <i class="bi bi-check-circle"></i> Spara
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Manager Selection Modal Styles */
#managerSelectionModal .member-list-item {
    padding: 0.75rem;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background-color 0.2s;
}

#managerSelectionModal .member-list-item:hover {
    background-color: #f8f9fa;
}

#managerSelectionModal .member-list-item:last-child {
    border-bottom: none;
}

#managerSelectionModal .member-info {
    flex: 1;
}

#managerSelectionModal .member-name {
    font-weight: 500;
    color: #212529;
}

#managerSelectionModal .member-club {
    font-size: 0.875rem;
    color: #6c757d;
}

#managerSelectionModal .manager-badge {
    background-color: #0d6efd;
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
}

#managerSelectionModal .manager-badge .btn-remove {
    background: none;
    border: none;
    color: white;
    padding: 0;
    margin: 0;
    cursor: pointer;
    font-size: 1.2rem;
    line-height: 1;
    opacity: 0.8;
    transition: opacity 0.2s;
}

#managerSelectionModal .manager-badge .btn-remove:hover {
    opacity: 1;
}

/* Mobile responsive */
@@media (max-width: 768px) {
    #managerSelectionModal .member-list-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }

    #managerSelectionModal .member-list-item .btn {
        width: 100%;
    }
}
</style>

<script>
// Manager Selection State
let managerSelectionState = {
    allMembers: [],
    selectedManagerIds: [],
    filteredMembers: [],
    selectedClubId: '' // For club filter
};

// Open Manager Selection Modal
function openManagerSelectionModal() {
    // Get current selected managers from hidden field
    const currentIds = document.getElementById('comp_competitionManagers_ids').value;
    managerSelectionState.selectedManagerIds = currentIds
        ? currentIds.split(',').map(id => parseInt(id)).filter(id => !isNaN(id))
        : [];

    // Load members if not already loaded
    if (managerSelectionState.allMembers.length === 0) {
        loadMembersForManagerSelection();
    } else {
        // Refresh display with current data
        filterManagerMembers('', '');
        updateSelectedManagersDisplay();
    }

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('managerSelectionModal'));
    modal.show();
}

// Load all members
function loadMembersForManagerSelection() {
    fetch('/umbraco/surface/MemberAdmin/GetMembers', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.data) {
            // Map the response to expected format with name and club fields
            managerSelectionState.allMembers = data.data.map(member => ({
                id: member.id,
                name: `${member.firstName || ''} ${member.lastName || ''}`.trim() || member.email,
                clubId: member.primaryClubId || '',
                clubName: member.primaryClubName || 'No Club'
            }));
            managerSelectionState.filteredMembers = managerSelectionState.allMembers;

            // Populate club filter dropdown
            populateClubFilter();

            renderManagerMembersList();
            updateSelectedManagersDisplay();
        } else {
            alert('Kunde inte ladda medlemmar: ' + (data.message || 'Okänt fel'));
        }
    })
    .catch(error => {
        console.error('Error loading members:', error);
        alert('Ett fel uppstod när medlemmar skulle laddas.');
    });
}

// Populate club filter dropdown with unique clubs
function populateClubFilter() {
    const clubFilterSelect = document.getElementById('clubFilterSelect');
    if (!clubFilterSelect) return;

    // Get unique clubs (sorted by name)
    const uniqueClubs = [...new Map(
        managerSelectionState.allMembers
            .filter(m => m.clubId) // Only members with clubs
            .map(m => [m.clubId, m.clubName])
    ).entries()]
        .map(([id, name]) => ({ id, name }))
        .sort((a, b) => a.name.localeCompare(b.name));

    // Clear existing options except "Alla klubbar"
    clubFilterSelect.innerHTML = '<option value="">Alla klubbar</option>';

    // Add club options
    uniqueClubs.forEach(club => {
        const option = document.createElement('option');
        option.value = club.id;
        option.textContent = club.name;
        clubFilterSelect.appendChild(option);
    });
}

// Search/Filter members (by name and club)
function filterManagerMembers(query = null, clubId = null) {
    // Use provided values or get from state/inputs
    const searchTerm = (query !== null ? query : document.getElementById('managerSearchInput')?.value || '').toLowerCase().trim();
    const selectedClub = clubId !== null ? clubId : managerSelectionState.selectedClubId;

    // Start with all members
    let filtered = managerSelectionState.allMembers;

    // Apply club filter
    if (selectedClub) {
        filtered = filtered.filter(member => member.clubId == selectedClub);
    }

    // Apply name search
    if (searchTerm) {
        filtered = filtered.filter(member => {
            const name = (member.name || '').toLowerCase();
            return name.includes(searchTerm);
        });
    }

    managerSelectionState.filteredMembers = filtered;
    renderManagerMembersList();
}

// Render members list
function renderManagerMembersList() {
    const container = document.getElementById('managerMembersList');
    const loadingSpinner = document.getElementById('managerLoadingSpinner');
    const noResults = document.getElementById('noManagerResults');

    // Hide loading spinner
    if (loadingSpinner) loadingSpinner.style.display = 'none';

    if (managerSelectionState.filteredMembers.length === 0) {
        container.innerHTML = '';
        noResults.classList.remove('d-none');
        document.getElementById('availableMemberCount').textContent = '0';
        return;
    }

    noResults.classList.add('d-none');
    document.getElementById('availableMemberCount').textContent = managerSelectionState.filteredMembers.length;

    const html = managerSelectionState.filteredMembers.map(member => {
        const isSelected = managerSelectionState.selectedManagerIds.includes(member.id);
        const buttonClass = isSelected ? 'btn-success' : 'btn-outline-primary';
        const buttonIcon = isSelected ? 'bi-check-circle-fill' : 'bi-plus-circle';
        const buttonText = isSelected ? 'Vald' : 'Lägg till';
        const buttonAction = isSelected ? `removeManagerFromSelection(${member.id})` : `addManagerToSelection(${member.id})`;

        return `
            <div class="member-list-item" data-member-id="${member.id}">
                <div class="member-info">
                    <div class="member-name">${escapeHtml(member.name)}</div>
                    <div class="member-club">${escapeHtml(member.clubName)}</div>
                </div>
                <button type="button" class="btn ${buttonClass} btn-sm" onclick="${buttonAction}">
                    <i class="bi ${buttonIcon}"></i> ${buttonText}
                </button>
            </div>
        `;
    }).join('');

    container.innerHTML = html;
}

// Add manager to selection
function addManagerToSelection(memberId) {
    if (!managerSelectionState.selectedManagerIds.includes(memberId)) {
        managerSelectionState.selectedManagerIds.push(memberId);
        updateSelectedManagersDisplay();
        renderManagerMembersList(); // Refresh to show updated button state
    }
}

// Remove manager from selection
function removeManagerFromSelection(memberId) {
    managerSelectionState.selectedManagerIds = managerSelectionState.selectedManagerIds.filter(id => id !== memberId);
    updateSelectedManagersDisplay();
    renderManagerMembersList(); // Refresh to show updated button state
}

// Update selected managers display (badges)
function updateSelectedManagersDisplay() {
    const section = document.getElementById('selectedManagersSection');
    const container = document.getElementById('selectedManagersList');
    const count = document.getElementById('selectedManagerCount');

    if (managerSelectionState.selectedManagerIds.length === 0) {
        section.style.display = 'none';
        return;
    }

    section.style.display = 'block';
    count.textContent = managerSelectionState.selectedManagerIds.length;

    const html = managerSelectionState.selectedManagerIds.map(memberId => {
        const member = managerSelectionState.allMembers.find(m => m.id === memberId);
        if (!member) return '';

        return `
            <span class="manager-badge">
                <span>${escapeHtml(member.name)}</span>
                <button type="button" class="btn-remove" onclick="removeManagerFromSelection(${memberId})" title="Ta bort">
                    ×
                </button>
            </span>
        `;
    }).join('');

    container.innerHTML = html;
}

// Save manager selection
function saveManagerSelection() {
    // Update hidden field in competition edit modal
    document.getElementById('comp_competitionManagers_ids').value = managerSelectionState.selectedManagerIds.join(',');

    // Update badges display in competition edit modal
    updateCompetitionManagerBadges();

    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('managerSelectionModal'));
    modal.hide();
}

// Update badges in competition edit modal
function updateCompetitionManagerBadges() {
    const container = document.getElementById('selectedManagersBadges');

    if (managerSelectionState.selectedManagerIds.length === 0) {
        container.innerHTML = '<small class="text-muted">Inga tävlingsledare valda</small>';
        return;
    }

    const html = managerSelectionState.selectedManagerIds.map(memberId => {
        const member = managerSelectionState.allMembers.find(m => m.id === memberId);
        if (!member) return '';

        return `<span class="badge bg-info me-1 mb-1">${escapeHtml(member.name)}</span>`;
    }).join('');

    container.innerHTML = html;
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Search input
    const searchInput = document.getElementById('managerSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            filterManagerMembers(e.target.value, null);
        });
    }

    // Club filter dropdown
    const clubFilterSelect = document.getElementById('clubFilterSelect');
    if (clubFilterSelect) {
        clubFilterSelect.addEventListener('change', function(e) {
            managerSelectionState.selectedClubId = e.target.value;
            filterManagerMembers(null, e.target.value);
        });
    }

    // Reset filters when modal is hidden
    document.getElementById('managerSelectionModal')?.addEventListener('hidden.bs.modal', function() {
        if (searchInput) searchInput.value = '';
        if (clubFilterSelect) clubFilterSelect.value = '';
        managerSelectionState.selectedClubId = '';
    });
});

// Helper function (if not already defined)
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
