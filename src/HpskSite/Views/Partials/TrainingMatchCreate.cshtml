@*
    Training Match Create Partial
    Form for creating a new training match
*@
@using HpskSite.Shared.Constants

<style>
/* Subtle placeholder text */
#createMatchForm input::placeholder {
    color: var(--bs-secondary-color);
    opacity: 0.5;
}
#createMatchForm .form-text {
    opacity: 0.7;
    font-size: 0.8rem;
}
</style>

<!-- Flatpickr Date/Time Picker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/sv.js"></script>

<div class="row justify-content-center mb-4">
    <div class="col-md-6">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Skapa ny match</h5>
            </div>
            <div class="card-body">
                <form id="createMatchForm" onsubmit="handleCreateMatch(event)">
                    <div class="mb-3">
                        <label for="createMatchName" class="form-label">Matchnamn (valfritt)</label>
                        <input type="text" class="form-control" id="createMatchName"
                               placeholder="T.ex. 'Fredagsträning' eller lämna tomt">
                    </div>

                    <div class="mb-3">
                        <label for="createWeaponClass" class="form-label">Vapenklass</label>
                        <select class="form-select" id="createWeaponClass" required>
                            <option value="C" selected>C - Kal. 22</option>
                            <option value="A">A - Tjänstevapen</option>
                            <option value="B">B - Kal. 32-45</option>
                            <option value="R">R - Revolver</option>
                            <option value="M">M - Magnum</option>
                            <option value="L">L - Luftpistol</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="createStartDate" class="form-label">
                            <i class="bi bi-calendar-event me-1"></i>Starttid (valfritt)
                        </label>
                        <input type="text" class="form-control" id="createStartDate"
                               placeholder="Lämna tomt för omedelbar start">
                        <div class="form-text">
                            Schemalägg matchen. Deltagare kan inte registrera poäng förrän matchen startat.
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="createIsOpen" checked>
                            <label class="form-check-label" for="createIsOpen">
                                <i class="bi bi-unlock me-1"></i>Öppen
                            </label>
                            <div class="form-text">
                                Alla medlemmar kan ansluta. Avmarkera för att endast tillåta anslutning via länk eller QR-kod.
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="createHasHandicap" checked>
                            <label class="form-check-label" for="createHasHandicap">
                                <i class="bi bi-balance-scale me-1"></i>Aktivera handicap
                            </label>
                            <button type="button" class="btn btn-link btn-sm p-0 ms-2 text-muted"
                                    data-bs-toggle="modal" data-bs-target="#handicapInfoModal"
                                    title="Läs mer om handicapsystemet">
                                <i class="bi bi-info-circle"></i>
                            </button>
                            <div class="form-text">
                                Använd handicapsystem för rättvis tävling mellan olika skyttenivåer.
                                Handicap beräknas per skytt och läggs till poängen.
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-play-fill me-1"></i> Starta match
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Handicap Info Modal -->
<div class="modal fade" id="handicapInfoModal" tabindex="-1" aria-labelledby="handicapInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="handicapInfoModalLabel">
                    <i class="bi bi-balance-scale me-2"></i>Så fungerar handicap
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Stäng"></button>
            </div>
            <div class="modal-body">
                <p>@HandicapInfo.Introduction</p>

                <h6 class="mt-3"><strong>@HandicapInfo.CalculationTitle</strong></h6>
                <ul class="mb-3">
                    <li>Baseras på ditt genomsnittliga serieresultat</li>
                    <li>En skytt med snitt 48 har handicap 0</li>
                    <li>Lägre snitt = positivt handicap (bonus)</li>
                    <li>Högre snitt = negativt handicap (avdrag)</li>
                </ul>

                <h6><strong>@HandicapInfo.StartingIndexTitle</strong></h6>
                <ul class="mb-3">
                    <li>Klass 1: 44 poäng (Nybörjare)</li>
                    <li>Klass 2: 46 poäng (Guldmärkesskytt)</li>
                    <li>Klass 3: 48 poäng (Riksmästare)</li>
                </ul>

                <h6><strong>@HandicapInfo.ProvisionalTitle</strong></h6>
                <ul class="mb-3">
                    <li>Handicap baseras på snitt från senaste 5 matcher</li>
                    <li>Nya skyttar: startindex fyller i saknade resultat</li>
                    <li>Visas med (P) tills 5 riktiga resultat finns</li>
                </ul>

                <h6><strong>@HandicapInfo.ProvisionalExampleTitle</strong></h6>
                <ul class="mb-3">
                    <li>0 matcher: (44+44+44+44+44)/5 = 44 → hcp +4</li>
                    <li>1 match (40p): (40+44+44+44+44)/5 = 43.2 → hcp +4.8</li>
                    <li>5 matcher: endast riktiga resultat används</li>
                </ul>

                <h6><strong>@HandicapInfo.ResultCalculationTitle</strong></h6>
                <ul class="mb-3">
                    <li>Handicap läggs till på VARJE serie</li>
                    <li>Max 50 poäng per serie (tak)</li>
                    <li>Slutresultat = summan av alla justerade serier</li>
                </ul>

                <h6><strong>@HandicapInfo.ExampleTitle</strong></h6>
                <p class="mb-1">Råpoäng: 47, 49, 46</p>
                <ul class="mb-2">
                    <li>Serie 1: 47 + 3 = 50 ✓</li>
                    <li>Serie 2: 49 + 3 = 52 → 50 (tak)</li>
                    <li>Serie 3: 46 + 3 = 49 ✓</li>
                    <li>Totalt: 149 poäng</li>
                </ul>

                <p class="text-muted small mb-0">
                    <i class="bi bi-info-circle me-1"></i>@HandicapInfo.Note
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Stäng</button>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize Flatpickr for start date
document.addEventListener('DOMContentLoaded', function() {
    flatpickr('#createStartDate', {
        locale: 'sv',
        enableTime: true,
        time_24hr: true,
        dateFormat: 'Y-m-d H:i',
        minDate: 'today',
        defaultHour: new Date().getHours() + 1,
        defaultMinute: 0,
        placeholder: 'Välj datum och tid...'
    });
});

function handleCreateMatch(e) {
    e.preventDefault();

    const matchName = document.getElementById('createMatchName').value.trim();
    const weaponClass = document.getElementById('createWeaponClass').value;
    const startDateStr = document.getElementById('createStartDate').value.trim();
    const isOpen = document.getElementById('createIsOpen').checked;
    const hasHandicap = document.getElementById('createHasHandicap').checked;

    // Convert date string to ISO format for .NET
    let startDate = null;
    if (startDateStr) {
        // Parse "2025-12-13 14:00" format and convert to ISO
        const date = new Date(startDateStr.replace(' ', 'T'));
        if (!isNaN(date.getTime())) {
            startDate = date.toISOString();
        }
    }

    createMatch(matchName || null, weaponClass, startDate, isOpen, hasHandicap);
}
</script>
