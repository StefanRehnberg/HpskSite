@*
    Training Match Create Partial
    Form for creating a new training match
*@
@using HpskSite.Shared.Constants

<style>
/* Subtle placeholder text */
#createMatchForm input::placeholder {
    color: var(--bs-secondary-color);
    opacity: 0.5;
}
#createMatchForm .form-text {
    opacity: 0.7;
    font-size: 0.8rem;
}
</style>

<!-- Flatpickr Date/Time Picker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/sv.js"></script>

<div class="row justify-content-center mb-4">
    <div class="col-md-6">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Skapa ny match</h5>
            </div>
            <div class="card-body">
                <form id="createMatchForm" onsubmit="handleCreateMatch(event)">
                    <div class="mb-3">
                        <label for="createMatchName" class="form-label">Matchnamn (valfritt)</label>
                        <input type="text" class="form-control" id="createMatchName"
                               placeholder="T.ex. 'Fredagsträning' eller lämna tomt">
                    </div>

                    <div class="mb-3">
                        <label for="createWeaponClass" class="form-label">Vapenklass</label>
                        <select class="form-select" id="createWeaponClass" required>
                            <option value="C" selected>C - Kal. 22</option>
                            <option value="A">A - Tjänstevapen</option>
                            <option value="B">B - Kal. 32-45</option>
                            <option value="R">R - Revolver</option>
                            <option value="M">M - Magnum</option>
                            <option value="L">L - Luftpistol</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="createStartDate" class="form-label">
                            <i class="bi bi-calendar-event me-1"></i>Starttid (valfritt)
                        </label>
                        <input type="text" class="form-control" id="createStartDate"
                               placeholder="Lämna tomt för omedelbar start">
                        <div class="form-text">
                            Schemalägg matchen. Deltagare kan inte registrera poäng förrän matchen startat.
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="createIsOpen" checked>
                            <label class="form-check-label" for="createIsOpen">
                                <i class="bi bi-unlock me-1"></i>Öppen
                            </label>
                            <div class="form-text">
                                Alla medlemmar kan ansluta. Avmarkera för att endast tillåta anslutning via länk eller QR-kod.
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="createHasHandicap" checked>
                            <label class="form-check-label" for="createHasHandicap">
                                <i class="bi bi-balance-scale me-1"></i>Aktivera handicap
                            </label>
                            <button type="button" class="btn btn-link btn-sm p-0 ms-2 text-muted"
                                    data-bs-toggle="modal" data-bs-target="#handicapInfoModal"
                                    title="Läs mer om handicapsystemet">
                                <i class="bi bi-info-circle"></i>
                            </button>
                            <div class="form-text">
                                Använd handicapsystem för rättvis tävling mellan olika skyttenivåer.
                                Handicap beräknas per skytt och läggs till poängen.
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="createIsTeamMatch" onchange="toggleTeamSettings()">
                            <label class="form-check-label" for="createIsTeamMatch">
                                <i class="bi bi-people me-1"></i>Lagmatch
                            </label>
                            <div class="form-text">
                                Tävla i lag. Lagets totalpoäng beräknas som summan av alla lagmedlemmars justerade poäng.
                            </div>
                        </div>
                    </div>

                    <!-- Team settings (shown when Lagmatch is checked) -->
                    <div id="teamSettings" style="display: none;">
                        <div class="card bg-body-tertiary mb-3">
                            <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-gear me-1"></i>Laginställningar</h6>

                                <div class="mb-3">
                                    <label for="maxShootersPerTeam" class="form-label">Antal skyttar per lag <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="maxShootersPerTeam" min="1" max="20" value="4">
                                    <div class="form-text">Begränsa antal deltagare i varje lag.</div>
                                </div>

                                <!-- Team definitions for closed matches -->
                                <div id="closedTeamSettings">
                                    <label class="form-label">Antal lag</label>
                                    <select class="form-select mb-3" id="teamCount" onchange="updateTeamInputs()">
                                        <option value="2">2 lag</option>
                                        <option value="3">3 lag</option>
                                        <option value="4">4 lag</option>
                                    </select>

                                    <div id="teamDefinitions">
                                        <!-- Team inputs will be generated dynamically -->
                                    </div>
                                </div>

                                <!-- Info for open matches -->
                                <div id="openTeamInfo" style="display: none;">
                                    <div class="alert alert-info mb-0">
                                        <i class="bi bi-info-circle me-1"></i>
                                        För öppna matcher kan deltagare skapa egna lag när de går med.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-play-fill me-1"></i> Starta match
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Handicap Info Modal -->
<div class="modal fade" id="handicapInfoModal" tabindex="-1" aria-labelledby="handicapInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="handicapInfoModalLabel">
                    <i class="bi bi-balance-scale me-2"></i>Så fungerar handicap
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Stäng"></button>
            </div>
            <div class="modal-body">
                <p>@HandicapInfo.Introduction</p>

                <h6 class="mt-3"><strong>@HandicapInfo.CalculationTitle</strong></h6>
                <ul class="mb-3">
                    <li>Baseras på ditt genomsnittliga serieresultat</li>
                    <li>En skytt med snitt 48 har handicap 0</li>
                    <li>Lägre snitt = positivt handicap (bonus)</li>
                    <li>Högre snitt = negativt handicap (avdrag)</li>
                </ul>

                <h6><strong>@HandicapInfo.StartingIndexTitle</strong></h6>
                <ul class="mb-3">
                    <li>Klass 1: 44 poäng (Nybörjare)</li>
                    <li>Klass 2: 46 poäng (Guldmärkesskytt)</li>
                    <li>Klass 3: 48 poäng (Riksmästare)</li>
                </ul>

                <h6><strong>@HandicapInfo.ProvisionalTitle</strong></h6>
                <ul class="mb-3">
                    <li>Handicap baseras på snitt från senaste 5 matcher</li>
                    <li>Nya skyttar: startindex fyller i saknade resultat</li>
                    <li>Visas med (P) tills 5 riktiga resultat finns</li>
                </ul>

                <h6><strong>@HandicapInfo.ProvisionalExampleTitle</strong></h6>
                <ul class="mb-3">
                    <li>0 matcher: (44+44+44+44+44)/5 = 44 → hcp +4</li>
                    <li>1 match (40p): (40+44+44+44+44)/5 = 43.2 → hcp +4.8</li>
                    <li>5 matcher: endast riktiga resultat används</li>
                </ul>

                <h6><strong>@HandicapInfo.ResultCalculationTitle</strong></h6>
                <ul class="mb-3">
                    <li>Handicap läggs till på VARJE serie</li>
                    <li>Max 50 poäng per serie (tak)</li>
                    <li>Slutresultat = summan av alla justerade serier</li>
                </ul>

                <h6><strong>@HandicapInfo.ExampleTitle</strong></h6>
                <p class="mb-1">Råpoäng: 47, 49, 46</p>
                <ul class="mb-2">
                    <li>Serie 1: 47 + 3 = 50 ✓</li>
                    <li>Serie 2: 49 + 3 = 52 → 50 (tak)</li>
                    <li>Serie 3: 46 + 3 = 49 ✓</li>
                    <li>Totalt: 149 poäng</li>
                </ul>

                <p class="text-muted small mb-0">
                    <i class="bi bi-info-circle me-1"></i>@HandicapInfo.Note
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Stäng</button>
            </div>
        </div>
    </div>
</div>

<script>
// Store loaded clubs for team affiliation (check if already declared by another partial)
if (typeof availableClubs === 'undefined') {
    var availableClubs = [];
}

// Initialize Flatpickr for start date
document.addEventListener('DOMContentLoaded', async function() {
    flatpickr('#createStartDate', {
        locale: 'sv',
        enableTime: true,
        time_24hr: true,
        dateFormat: 'Y-m-d H:i',
        minDate: 'today',
        defaultHour: new Date().getHours() + 1,
        defaultMinute: 0,
        placeholder: 'Välj datum och tid...'
    });

    // Load clubs for team affiliation
    await loadClubs();

    // Initialize team inputs
    updateTeamInputs();

    // Listen for isOpen changes to toggle team settings
    document.getElementById('createIsOpen').addEventListener('change', updateTeamVisibility);
});

async function loadClubs() {
    try {
        const response = await fetch('/umbraco/surface/ClubAdmin/GetClubsPublic');
        const result = await response.json();
        if (result.success && result.clubs) {
            availableClubs = result.clubs.sort((a, b) => a.name.localeCompare(b.name, 'sv'));
        }
    } catch (error) {
        console.error('Failed to load clubs:', error);
    }
}

function toggleTeamSettings() {
    const isTeamMatch = document.getElementById('createIsTeamMatch').checked;
    document.getElementById('teamSettings').style.display = isTeamMatch ? 'block' : 'none';
    if (isTeamMatch) {
        updateTeamVisibility();
    }
}

function updateTeamVisibility() {
    const isOpen = document.getElementById('createIsOpen').checked;
    document.getElementById('closedTeamSettings').style.display = isOpen ? 'none' : 'block';
    document.getElementById('openTeamInfo').style.display = isOpen ? 'block' : 'none';
}

function updateTeamInputs() {
    const teamCount = parseInt(document.getElementById('teamCount').value);
    const container = document.getElementById('teamDefinitions');
    container.innerHTML = '';

    // Build club options HTML
    let clubOptionsHtml = '<option value="">Ingen klubb</option>';
    for (const club of availableClubs) {
        clubOptionsHtml += `<option value="${club.id}">${club.name}</option>`;
    }

    for (let i = 1; i <= teamCount; i++) {
        const teamDiv = document.createElement('div');
        teamDiv.className = 'mb-3';
        teamDiv.innerHTML = `
            <label class="form-label small text-body-secondary mb-1">Lag ${i}</label>
            <div class="row g-2">
                <div class="col-7">
                    <input type="text" class="form-control team-name-input" id="teamName${i}"
                           placeholder="Lagnamn">
                </div>
                <div class="col-5">
                    <select class="form-select team-club-select" id="teamClub${i}">
                        ${clubOptionsHtml}
                    </select>
                </div>
            </div>
        `;
        container.appendChild(teamDiv);
    }
}

function getTeamDefinitions() {
    const isOpen = document.getElementById('createIsOpen').checked;
    if (isOpen) {
        return null; // No pre-defined teams for open matches
    }

    const teamCount = parseInt(document.getElementById('teamCount').value);
    const teams = [];

    for (let i = 1; i <= teamCount; i++) {
        const nameInput = document.getElementById(`teamName${i}`);
        const clubSelect = document.getElementById(`teamClub${i}`);
        const teamName = nameInput?.value?.trim();
        if (!teamName) {
            return null; // Invalid - all teams need names
        }

        // Get club ID (parse as int, or null if empty/invalid)
        const clubIdStr = clubSelect?.value;
        const clubId = clubIdStr ? parseInt(clubIdStr, 10) : null;

        teams.push({
            teamNumber: i,
            teamName: teamName,
            clubId: isNaN(clubId) ? null : clubId
        });
    }

    return teams;
}

function handleCreateMatch(e) {
    e.preventDefault();
    console.log('handleCreateMatch called');

    const matchName = document.getElementById('createMatchName').value.trim();
    const weaponClass = document.getElementById('createWeaponClass').value;
    const startDateStr = document.getElementById('createStartDate').value.trim();
    const isOpen = document.getElementById('createIsOpen').checked;
    const hasHandicap = document.getElementById('createHasHandicap').checked;
    const isTeamMatch = document.getElementById('createIsTeamMatch').checked;

    // Convert date string to ISO format for .NET
    let startDate = null;
    if (startDateStr) {
        // Parse "2025-12-13 14:00" format and convert to ISO
        const date = new Date(startDateStr.replace(' ', 'T'));
        if (!isNaN(date.getTime())) {
            startDate = date.toISOString();
        }
    }

    // Validate team match settings
    let maxShootersPerTeam = null;
    let teams = null;

    if (isTeamMatch) {
        maxShootersPerTeam = parseInt(document.getElementById('maxShootersPerTeam').value);
        if (!maxShootersPerTeam || maxShootersPerTeam <= 0) {
            alert('Ange max antal skyttar per lag');
            return;
        }

        // Get team definitions for closed matches
        if (!isOpen) {
            teams = getTeamDefinitions();
            if (!teams) {
                alert('Ange namn för alla lag');
                return;
            }
        }
    }

    createMatch(matchName || null, weaponClass, startDate, isOpen, hasHandicap, isTeamMatch, maxShootersPerTeam, teams);
}
</script>
