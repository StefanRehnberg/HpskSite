@*
 * Series Copy Modal
 * Copy series with date selection and competition selection
*@

<!-- Flatpickr CSS & JS for date pickers -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/sv.js"></script>

<div class="modal fade" id="seriesCopyModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="bi bi-files me-2"></i>Copy Series
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <!-- Error Alert -->
                <div class="alert alert-danger d-none" id="copyErrorAlert" role="alert">
                    <strong>Error:</strong> <span id="copyErrorMessage"></span>
                </div>

                <!-- Info Section -->
                <div class="card mb-4 border-info">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Series Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><small class="text-muted">Original Name</small></p>
                                <p class="mb-3"><strong id="copySourceSeriesName">-</strong></p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><small class="text-muted">New Name</small></p>
                                <p class="mb-3"><strong id="copyNewSeriesName">-</strong></p>
                            </div>
                        </div>

                        <!-- Date Fields -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="copySeries StartDate" class="form-label">Start Date <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="copySeriesStartDate" name="copySeriesStartDate" placeholder="Select start date" required>
                                    <small class="form-text text-muted">Required - determines series year folder</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="copySeriesEndDate" class="form-label">End Date</label>
                                    <input type="text" class="form-control" id="copySeriesEndDate" name="copySeriesEndDate" placeholder="Select end date">
                                    <small class="form-text text-muted">Optional</small>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            <strong>Note:</strong> The new series will be created with these dates. Competitions will be copied without dates.
                        </div>
                    </div>
                </div>

                <!-- Competition Selection -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-collection me-2"></i>Select Competitions to Copy</h6>
                    </div>
                    <div class="card-body">
                        <div id="competitionChecklist" class="competition-checklist">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="copySeriesWithCompetitionsBtn" onclick="performSeriesCopy()">
                    <i class="bi bi-files me-1"></i>Copy Series
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize copy modal when it's about to show
document.addEventListener('DOMContentLoaded', function() {
    const copyModal = document.getElementById('seriesCopyModal');
    if (copyModal) {
        copyModal.addEventListener('show.bs.modal', function() {
            // Initialize Flatpickr for date fields
            const startDateInput = document.getElementById('copySeriesStartDate');
            const endDateInput = document.getElementById('copySeriesEndDate');

            if (startDateInput && !startDateInput._flatpickr) {
                flatpickr(startDateInput, {
                    enableTime: false,
                    dateFormat: 'Y-m-d',
                    locale: 'sv'
                });
            }

            if (endDateInput && !endDateInput._flatpickr) {
                flatpickr(endDateInput, {
                    enableTime: false,
                    dateFormat: 'Y-m-d',
                    locale: 'sv'
                });
            }

            // Clear error alert when modal opens
            document.getElementById('copyErrorAlert').classList.add('d-none');
        });
    }
});

// Populate copy modal (called from AdminSeriesList)
window.populateCopyModal = function(seriesId, competitions) {
    // Update series name preview
    const sourceSeriesName = document.getElementById('copySourceSeriesName');
    const newSeriesName = document.getElementById('copyNewSeriesName');

    if (sourceSeriesName && newSeriesName && window.currentSeriesDataForCopy) {
        const sourceName = window.currentSeriesDataForCopy.seriesName || 'Unknown';
        sourceSeriesName.textContent = sourceName;
        newSeriesName.textContent = sourceName + ' - Copy';
    }

    // Clear date fields when opening modal
    const startDateInput = document.getElementById('copySeriesStartDate');
    const endDateInput = document.getElementById('copySeriesEndDate');
    if (startDateInput) startDateInput.value = '';
    if (endDateInput) endDateInput.value = '';

    const checklist = document.getElementById('competitionChecklist');
    if (!checklist) {
        console.error('competitionChecklist element not found');
        return;
    }

    if (!competitions || competitions.length === 0) {
        checklist.innerHTML = `
            <div class="alert alert-info mb-0">
                <i class="bi bi-inbox me-2"></i>
                This series has no competitions. A new empty series will be created.
            </div>
        `;
    } else {
        const htmlContent = `
            <div class="mb-3 d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" type="button" onclick="selectAllCompetitions()">
                    <i class="bi bi-check-all me-1"></i>Select All
                </button>
                <button class="btn btn-sm btn-outline-secondary" type="button" onclick="deselectAllCompetitions()">
                    <i class="bi bi-x-circle me-1"></i>Deselect All
                </button>
            </div>
            <div class="competition-list" style="max-height: 300px; overflow-y: auto;">
                ${competitions.map(c => `
                    <div style="padding: 10px; border: 1px solid #ddd; margin-bottom: 8px; border-radius: 4px; display: flex; align-items: center; gap: 10px;">
                        <input class="competition-checkbox" type="checkbox" id="copy_comp_${c.id}" value="${c.id}" checked style="width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                        <label for="copy_comp_${c.id}" style="flex: 1; margin: 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                            <span>${escapeHtml(c.name)}</span>
                            <span style="color: #666; font-size: 12px;">${formatDate(c.competitionDate)} • ${getCompetitionStatusBadge(c.status)}</span>
                        </label>
                    </div>
                `).join('')}
            </div>
        `;

        checklist.innerHTML = htmlContent;

        // Add event listeners to checkboxes
        document.querySelectorAll('.competition-checkbox').forEach(cb => {
            cb.addEventListener('change', updateCopyButtonText);
        });
    }

    updateCopyButtonText();
};

// Select all competitions
window.selectAllCompetitions = function() {
    document.querySelectorAll('.competition-checkbox').forEach(cb => cb.checked = true);
    updateCopyButtonText();
};

// Deselect all competitions
window.deselectAllCompetitions = function() {
    document.querySelectorAll('.competition-checkbox').forEach(cb => cb.checked = false);
    updateCopyButtonText();
};

// Update button text with count
function updateCopyButtonText() {
    const selectedCount = document.querySelectorAll('.competition-checkbox:checked').length;
    const copyBtn = document.getElementById('copySeriesWithCompetitionsBtn');
    if (copyBtn) {
        if (selectedCount === 0) {
            copyBtn.textContent = `Copy Series (No Competitions)`;
        } else {
            copyBtn.textContent = `Copy Series + ${selectedCount} Competition${selectedCount !== 1 ? 's' : ''}`;
        }
    }
}

// Perform the copy operation
window.performSeriesCopy = function() {
    // Validate start date is present
    const startDateInput = document.getElementById('copySeriesStartDate');
    const endDateInput = document.getElementById('copySeriesEndDate');
    const errorAlert = document.getElementById('copyErrorAlert');
    const errorMessage = document.getElementById('copyErrorMessage');

    if (!startDateInput || !startDateInput.value) {
        errorMessage.textContent = 'Start date is required to copy series';
        errorAlert.classList.remove('d-none');
        return;
    }

    if (!window.currentSeriesDataForCopy) {
        errorMessage.textContent = 'Error: Series data not found';
        errorAlert.classList.remove('d-none');
        return;
    }

    // Parse dates
    const startDateStr = startDateInput.value;
    const endDateStr = endDateInput.value;
    let startDate = null;
    let endDate = null;

    try {
        if (startDateStr) {
            const dateParts = startDateStr.split('-');
            startDate = new Date(`${dateParts[0]}-${dateParts[1]}-${dateParts[2]}T00:00:00`).toISOString();
        }
        if (endDateStr) {
            const dateParts = endDateStr.split('-');
            endDate = new Date(`${dateParts[0]}-${dateParts[1]}-${dateParts[2]}T00:00:00`).toISOString();
        }
    } catch (e) {
        errorMessage.textContent = 'Invalid date format';
        errorAlert.classList.remove('d-none');
        return;
    }

    const selectedCompetitions = Array.from(document.querySelectorAll('.competition-checkbox:checked'))
        .map(cb => parseInt(cb.value));

    const copyBtn = document.getElementById('copySeriesWithCompetitionsBtn');
    const originalText = copyBtn.innerHTML;
    copyBtn.disabled = true;
    copyBtn.innerHTML = '<i class="bi bi-spinner-border spinner-border-sm"></i> Kopierar...';

    const requestBody = {
        sourceSeriesId: window.currentSeriesDataForCopy.seriesId,
        competitionIdsToCopy: selectedCompetitions,
        startDate: startDate,
        endDate: endDate
    };

    fetch('/umbraco/surface/CompetitionAdmin/CopySeriesWithCompetitions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
        },
        body: JSON.stringify(requestBody)
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`HTTP ${response.status}: ${text}`);
            });
        }
        return response.json();
    })
    .then(data => {
        copyBtn.disabled = false;
        copyBtn.innerHTML = originalText;

        if (data.success) {
            showNotification(data.message || 'Serie kopierad framgångsrikt!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('seriesCopyModal')).hide();

            if (typeof loadSeriesList === 'function') {
                setTimeout(() => {
                    loadSeriesList();
                }, 500);
            }
        } else {
            showNotification(data.message || 'Ett fel uppstod vid kopiering', 'error');
        }
    })
    .catch(error => {
        copyBtn.disabled = false;
        copyBtn.innerHTML = originalText;
        showNotification(error.message || 'Ett fel uppstod vid kopiering', 'error');
    });
};

// Helper functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('sv-SE');
}

function getCompetitionStatusBadge(status) {
    const badges = {
        'Draft': '<span class="badge bg-secondary">Draft</span>',
        'Scheduled': '<span class="badge bg-primary">Scheduled</span>',
        'Active': '<span class="badge bg-success">Active</span>',
        'Completed': '<span class="badge bg-dark">Completed</span>'
    };
    return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
}

function showNotification(message, type) {
    if (typeof toastr !== 'undefined') {
        toastr[type](message);
    } else {
        alert(message);
    }
}
</script>

<style>
.competition-checklist {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.75rem;
}

.competition-list div:hover {
    background-color: #f8f9fa;
    transition: background-color 0.15s ease-in-out;
}
</style>
