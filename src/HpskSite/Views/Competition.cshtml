@using HpskSite.Models
@using HpskSite.Extensions
@using Umbraco.Cms.Web.Common.PublishedModels;
@using System.Linq;
@using System;
@using System.Globalization;
@inject Umbraco.Cms.Core.Services.IMemberService MemberService
@inject Umbraco.Cms.Core.Security.IMemberManager MemberManager
@inject HpskSite.Services.AdminAuthorizationService AuthService
@inject HpskSite.Services.ClubService ClubService
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage
@{
	Layout = "Master.cshtml";
	ViewBag.Title = Model.Value<string>("competitionName") ?? "Competition";

	// Get competition manager IDs from JSON array
	var competitionManagersJson = Model.Value<string>("competitionManagers") ?? "[]";
	int[] managerIds;
	try
	{
		managerIds = Newtonsoft.Json.JsonConvert.DeserializeObject<int[]>(competitionManagersJson) ?? Array.Empty<int>();
	}
	catch
	{
		managerIds = Array.Empty<int>();
	}

    var competitionName = Model.Value<string>("competitionName") ?? "";
    var description = Model.Value<string>("description") ?? "";
    var competitionDate = Model.Value<DateTime>("competitionDate");
    var competitionEndDate = Model.Value<DateTime?>("competitionEndDate");
    var venue = Model.Value<string>("venue") ?? "";

    // Multi-day competition logic
    var hasValidEndDate = competitionEndDate.HasValue &&
                          competitionEndDate.Value > DateTime.MinValue &&
                          competitionEndDate.Value.Year > 1900 &&
                          competitionEndDate.Value.Date >= competitionDate.Date;
    var isMultiDay = hasValidEndDate && competitionEndDate!.Value.Date != competitionDate.Date;
    var dateIcon = isMultiDay ? "üìÖ" : "üïê";
    var durationInfo = isMultiDay ?
        $"({(competitionEndDate.Value.Date - competitionDate.Date).Days + 1} dagar)" :
        "(1 dag)";
    var maxParticipants = Model.Value<int>("maxParticipants");
    var registrationFee = Model.Value<string>("registrationFee") ?? "";
    var registrationOpenDate = Model.Value<DateTime>("registrationOpenDate");
    var registrationCloseDate = Model.Value<DateTime>("registrationCloseDate");
    var competitionDirector = Model.Value<string>("competitionDirector") ?? "";
    var contactEmail = Model.Value<string>("contactEmail") ?? "";
    var contactPhone = Model.Value<string>("contactPhone") ?? "";
    var isActive = Model.Value<bool>("isActive");
    var showLiveResults = Model.Value<bool>("showLiveResults");
    var competitionType = Model.Value<IPublishedContent>("competitionType");
    var numberOfSeriesOrStations = Model.Value<int>("numberOfSeriesOrStations");
    var numberOfFinalSeries = Model.Value<int>("numberOfFinalSeries");

    // External competition properties
    var isExternal = Model.Value<bool>("isExternal");
    var externalUrl = Model.Value<string>("externalUrl");
    var externalRegistrationEmail = Model.Value<string>("externalRegistrationEmail");
    IPublishedContent? invitationFile = null;
    try
    {
        invitationFile = Model.Value<IPublishedContent>("invitationFile");
    }
    catch (ArgumentException)
    {
        // Invalid invitation file path - ignore and continue
    }
    var hasInvitation = invitationFile != null;
    // Get multiple shooting classes support - handle both string array and comma-separated string
    var shootingClassIdsRaw = Model.Value("shootingClassIds");
    var shootingClassIds = "";

    // Handle different data types from Umbraco multiselect
    if (shootingClassIdsRaw is string[] stringArray)
    {
        shootingClassIds = string.Join(",", stringArray);
    }
    else if (shootingClassIdsRaw is IEnumerable<string> enumerable)
    {
        shootingClassIds = string.Join(",", enumerable);
    }
    else if (shootingClassIdsRaw is string stringValue)
    {
        shootingClassIds = stringValue ?? "";
    }
    else if (shootingClassIdsRaw != null)
    {
        // Try generic Value<T> approach for Flexible Dropdown
        try
        {
            var typed = Model.Value<IEnumerable<string>>("shootingClassIds");
            if (typed != null)
            {
                shootingClassIds = string.Join(",", typed);
            }
        }
        catch
        {
            // Fallback to empty if all parsing fails
            shootingClassIds = "";
        }
    }

    var allowDualCClassRegistration = Model.Value<bool>("allowDualCClassRegistration");

    // Get competition shooting classes using Models.ShootingClasses
    var competitionShootingClasses = new List<ShootingClass>();

    // Try to parse shooting class IDs - handle JSON array format
    if (!string.IsNullOrEmpty(shootingClassIds))
    {
        var ids = new List<string>();

        // Check if it's a JSON array format: ["A1","B2"]
        if (shootingClassIds.StartsWith("[") && shootingClassIds.EndsWith("]"))
        {
            try
            {
                // Parse JSON array manually (simple approach)
                var jsonContent = shootingClassIds.Substring(1, shootingClassIds.Length - 2); // Remove [ and ]
                ids.AddRange(jsonContent.Split(',')
                    .Select(s => s.Trim().Trim('"'))
                    .Where(s => !string.IsNullOrEmpty(s)));
            }
            catch
            {
                // If JSON parsing fails, try as comma-separated
                ids.AddRange(shootingClassIds.Split(',')
                    .Select(id => id.Trim())
                    .Where(id => !string.IsNullOrEmpty(id)));
            }
        }
        else
        {
            // Already comma-separated or single value
            ids.AddRange(shootingClassIds.Split(',')
                .Select(id => id.Trim())
                .Where(id => !string.IsNullOrEmpty(id)));
        }

        foreach (var id in ids)
        {
            var shootingClass = HpskSite.Models.ShootingClasses.GetById(id);
            if (shootingClass != null)
            {
                competitionShootingClasses.Add(shootingClass);
            }
        }
    }


    var hasShootingClasses = competitionShootingClasses.Any();
    var shootingClassNames = hasShootingClasses
        ? string.Join(", ", competitionShootingClasses.Select(sc => sc.Name))
        : "Inga klasser angivna";

    // Group available shooting classes by category for smart registration
    var aClasses = competitionShootingClasses.Where(sc => sc.Id.StartsWith("A")).ToList();
    var bClasses = competitionShootingClasses.Where(sc => sc.Id.StartsWith("B")).ToList();
    var cClasses = competitionShootingClasses.Where(sc => sc.Id.StartsWith("C")).ToList();
    var rClasses = competitionShootingClasses.Where(sc => sc.Id.StartsWith("R")).ToList();
    var lClasses = competitionShootingClasses.Where(sc => sc.Id.StartsWith("L")).ToList();
    var mClasses = competitionShootingClasses.Where(sc => sc.Id.StartsWith("M")).ToList();

    // Subdivide C classes into subcategories for proper validation
    var cRegularClasses = cClasses.Where(sc => sc.Id == "C1" || sc.Id == "C2" || sc.Id == "C3").ToList();
    var cVetClasses = cClasses.Where(sc => sc.Id == "C_Vet_Y" || sc.Id == "C_Vet_A").ToList();
    var cJuniorClasses = cClasses.Where(sc => sc.Id == "C_Jun").ToList();
    var cDamClasses = cClasses.Where(sc => sc.Id.EndsWith("_Dam") && sc.Id.StartsWith("C")).ToList();

    // Subdivide L classes into subcategories (same structure as C)
    var lRegularClasses = lClasses.Where(sc => sc.Id == "L1" || sc.Id == "L2" || sc.Id == "L3").ToList();
    var lVetClasses = lClasses.Where(sc => sc.Id == "L_Vet_Y" || sc.Id == "L_Vet_A").ToList();
    var lJuniorClasses = lClasses.Where(sc => sc.Id == "L_Jun").ToList();
    var lDamClasses = lClasses.Where(sc => sc.Id.EndsWith("_Dam") && sc.Id.StartsWith("L")).ToList();

    var now = DateTime.Now;
    string status = "Ok√§nd";
    string badgeClass = "secondary";

    if (!isActive)
    {
        status = "Inaktiv";
        badgeClass = "danger";
    }
    else if (now < registrationOpenDate)
    {
        status = "Anm√§lan √∂ppnar snart";
        badgeClass = "info";
    }
    else if (now >= registrationOpenDate && now <= registrationCloseDate)
    {
        status = "Anm√§lan √∂ppen";
        badgeClass = "success";
    }
    else if (now > registrationCloseDate && now < competitionDate)
    {
        status = "Anm√§lan st√§ngd";
        badgeClass = "warning";
    }
    else if (now.Date == competitionDate.Date)
    {
        status = "T√§vling idag";
        badgeClass = "primary";
    }
    else if (now > competitionDate)
    {
        status = "T√§vlingen avslutad";
        badgeClass = "secondary";
    }

    // Check if current user can manage this competition
    var currentMember = await MemberManager.GetCurrentMemberAsync();
    bool canManageCompetition = false;

    // Get current user info for highlighting in registered shooters modal
    var currentMemberName = currentMember?.Name ?? "";
    var currentMemberClub = "";
    if (currentMember != null)
    {
        var memberData = MemberService.GetByEmail(currentMember.Email ?? "");
        if (memberData != null)
        {
            var primaryClubIdStr = memberData.GetValue<string>("primaryClubId");
            if (!string.IsNullOrEmpty(primaryClubIdStr) && int.TryParse(primaryClubIdStr, out int primaryClubId))
            {
                currentMemberClub = ClubService.GetClubNameById(primaryClubId) ?? "";
            }
        }
    }

    if (currentMember != null)
    {
        // Check if user is site admin (using centralized service)
        bool isSiteAdmin = await AuthService.IsCurrentUserAdminAsync();

        // Check if user is competition manager (using ID-based check)
        bool isCompetitionManager = await AuthService.IsCompetitionManager(Model.Id);

        // Check if user is club admin for this competition's club
        bool isClubAdminForCompetition = false;
        var competitionClubId = Model.Value<int>("clubId");
        if (competitionClubId > 0)
        {
            isClubAdminForCompetition = await AuthService.IsClubAdminForClub(competitionClubId);
        }

        canManageCompetition = isSiteAdmin || isCompetitionManager || isClubAdminForCompetition;
    }
}

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Breadcrumb with Series Context -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="@Model.Root().Url()">Hem</a></li>
                    @if (Model.Parent?.ContentType.Alias == "competitionsHub")
                    {
                        <li class="breadcrumb-item"><a href="@Model.Parent.Url()">T√§vlingar</a></li>
                    }
                    else if (Model.Parent?.ContentType.Alias == "competitionSeries")
                    {
                        @if (Model.Parent.Parent?.ContentType.Alias == "competitionsHub")
                        {
                            <li class="breadcrumb-item"><a href="@Model.Parent.Parent.Url()">T√§vlingar</a></li>
                        }
                        else if (Model.Parent.Parent?.ContentType.Alias == "competitionSeason")
                        {
                            <li class="breadcrumb-item"><a href="@Model.Parent.Parent.Parent.Url()">T√§vlingar</a></li>
                            <li class="breadcrumb-item"><a href="@Model.Parent.Parent.Url()">@Model.Parent.Parent.Name</a></li>
                        }
                        <li class="breadcrumb-item"><a href="@Model.Parent.Url()">@Model.Parent.Name</a></li>
                    }
                    else if (Model.Parent?.ContentType.Alias == "competitionSeason")
                    {
                        <li class="breadcrumb-item"><a href="@Model.Parent.Parent.Url()">T√§vlingar</a></li>
                        <li class="breadcrumb-item"><a href="@Model.Parent.Url()">@Model.Parent.Name</a></li>
                    }
                    <li class="breadcrumb-item active">@competitionName</li>
                </ol>
            </nav>
        </div>
    </div>

    @* Series Information Banner (when competition is part of a series) *@
    @if (Model.Parent?.ContentType.Alias == "competitionSeries")
    {
        var seriesContent = Model.Parent;
        var seriesName = seriesContent.Value<string>("seriesName") ?? seriesContent.Name;
        var seriesLogo = seriesContent.Value<IPublishedContent>("seriesLogo");
        var allSeriesCompetitions = seriesContent.Children.Where(x => x.ContentType.Alias == "competition")
                                                          .OrderBy(x => x.Value<int?>("seriesSortOrder") ?? int.MaxValue)
                                                          .ThenBy(x => x.Value<DateTime>("competitionDate"))
                                                          .ToList();
        var currentIndex = allSeriesCompetitions.FindIndex(x => x.Id == Model.Id);
        var roundNumber = currentIndex + 1;
        var totalRounds = allSeriesCompetitions.Count();
        var previousCompetition = currentIndex > 0 ? allSeriesCompetitions[currentIndex - 1] : null;
        var nextCompetition = currentIndex < allSeriesCompetitions.Count - 1 ? allSeriesCompetitions[currentIndex + 1] : null;

        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="d-flex align-items-center">
                                    @if (seriesLogo != null)
                                    {
                                        <img src="@seriesLogo.Url()" alt="@seriesName Logo" class="me-3" style="max-height: 40px; max-width: 60px;">
                                    }
                                    <div>
                                        <h5 class="mb-1">üèÜ @seriesName</h5>
                                        <small class="opacity-75">Omg√•ng @roundNumber av @totalRounds</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <a href="@seriesContent.Url()" class="btn btn-light btn-sm">
                                    <i class="bi bi-list"></i> Visa serie
                                </a>
                            </div>
                        </div>
                    </div>
                    @if (previousCompetition != null || nextCompetition != null)
                    {
                        <div class="card-footer bg-light">
                            <div class="row align-items-center">
                                <div class="col-6 col-md-4">
                                    @if (previousCompetition != null)
                                    {
                                        <a href="@previousCompetition.CompetitionUrl()" class="btn btn-outline-secondary btn-sm">
                                            <i class="bi bi-chevron-left"></i> F√∂reg√•ende
                                        </a>
                                    }
                                    else
                                    {
                                        <span class="text-muted small">Visar f√∂rsta t√§vlingen i serien</span>
                                    }
                                </div>
                                <div class="d-none d-md-block col-md-4 text-center">
                                    <small class="text-muted">@seriesName navigering</small>
                                </div>
                                <div class="col-6 col-md-4 text-end">
                                    @if (nextCompetition != null)
                                    {
                                        <a href="@nextCompetition.CompetitionUrl()" class="btn btn-outline-secondary btn-sm">
                                            N√§sta <i class="bi bi-chevron-right"></i>
                                        </a>
                                    }
                                    else
                                    {
                                        <span class="text-muted small">Visar sista t√§vlingen i serien</span>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    <div class="row">
        <div class="col-lg-8">
			<div class="card mb-4">
			<div class="card-header">
			<div class="d-flex justify-content-between align-items-center">
			<h2 class="card-title h4 mb-0">@competitionName</h2>
			<div class="d-flex gap-2 align-items-center">
			@* ======================================== EXTERNAL COMPETITION BUTTONS ======================================== *@
			@if (isExternal)
			{
				@* External competition - show external link and email button *@
				@if (!string.IsNullOrEmpty(externalUrl))
				{
					<a href="@externalUrl" target="_blank" class="btn btn-info">
						<i class="bi bi-box-arrow-up-right"></i> G√• till t√§vlingssida
					</a>
				}

				@if (!string.IsNullOrEmpty(externalRegistrationEmail) && isActive && now >= registrationOpenDate && now <= registrationCloseDate)
				{
					<a href="mailto:@externalRegistrationEmail?subject=Anm√§lan till @Uri.EscapeDataString(competitionName)"
					   class="btn btn-outline-info">
						<i class="bi bi-envelope"></i> Anm√§l via e-post
					</a>
				}
			}
			@* ======================================== INTERNAL COMPETITION BUTTONS ======================================== *@
			else
			{
				@* Registration buttons *@
				@if (isActive && now >= registrationOpenDate && now <= registrationCloseDate && hasShootingClasses)
				{
				<button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#registrationModal">
				<i class="bi bi-person-plus"></i> Anm√§l
				</button>
				}
								 else if (isActive && now > registrationCloseDate && now < competitionDate)
				{
				 <button class="btn btn-warning" disabled>
				  <i class="bi bi-calendar-x"></i> Anm√§lan st√§ngd
				</button>
				}
				else if (!isActive)
				{
				<button class="btn btn-secondary" disabled>
				  <i class="bi bi-pause-circle"></i> Inte aktiv
				</button>
				}

				@* Management button (admin/competition manager only) - Bulls eye icon only *@
				@if (canManageCompetition)
				{
				<a href="/competitionmanagement?competitionId=@Model.Id" class="btn btn-outline-secondary" title="Hantera t√§vling">
				<i class="bi bi-bullseye"></i>
				</a>
				}
			}
			</div>
			</div>
			</div>
				<div class="card-body">
					<div class="row">
						<div class="col-md-6">
							<p><strong>Datum & Plats:</strong></p>
							<ul class="list-unstyled">
								<li>
									@dateIcon
									@if (isMultiDay)
									{
										<strong>@competitionDate.ToString("dddd, d MMMM", CultureInfo.GetCultureInfo("sv-SE")) - @competitionEndDate!.Value.ToString("dddd, d MMMM yyyy", CultureInfo.GetCultureInfo("sv-SE"))</strong>
										<small class="text-muted">@durationInfo</small>
									}
									else
									{
										<strong>@competitionDate.ToString("dddd, d MMMM yyyy", CultureInfo.GetCultureInfo("sv-SE"))</strong>
										<small class="text-muted">@durationInfo</small>
									}
								</li>
								<li><i class="bi bi-geo-alt"></i> @venue</li>
							</ul>

							<p><strong>Skjutklasser:</strong></p>
							@if (hasShootingClasses)
							{
								<div class="mb-2">
									@foreach (var shootingClass in competitionShootingClasses)
									{
										<span class="badge bg-primary me-2"
											  data-bs-toggle="tooltip"
											  data-bs-placement="top"
											  title="@shootingClass.Description">@shootingClass.Name</span>
									}
								</div>
							}
							else
							{
								<div class="alert alert-warning mb-2">
									<i class="bi bi-exclamation-triangle"></i> Inga skytteklasser har angivits f√∂r denna t√§vling.
								</div>
							}
						</div>
						<div class="col-md-6">
							<p><strong>Anm√§lningsdetaljer:</strong></p>
							<ul class="list-unstyled">
								@if (!isExternal)
								{
									<li><i class="bi bi-people"></i> Max antal deltagare: <strong>@maxParticipants</strong></li>
									<li><i class="bi bi-currency-dollar"></i> Avgift: <strong>@registrationFee</strong></li>
								}
								<li><i class="bi bi-calendar-check"></i> √ñppnar: @registrationOpenDate.ToString("d MMM yyyy", CultureInfo.GetCultureInfo("sv-SE"))</li>
								<li><i class="bi bi-calendar-x"></i> St√§nger: @registrationCloseDate.ToString("d MMM yyyy", CultureInfo.GetCultureInfo("sv-SE"))</li>
							</ul>

							<p><strong>T√§vlingsinformation:</strong></p>
							<ul class="list-unstyled">
								@if (competitionType != null)
								{
									<li><i class="bi bi-trophy"></i> Typ: <strong>@competitionType.Name</strong></li>
								}
								<li><i class="bi bi-list-ol"></i> Antal serier: <strong>@(numberOfFinalSeries > 0 ? $"{numberOfSeriesOrStations - numberOfFinalSeries} + {numberOfFinalSeries}" : $"{numberOfSeriesOrStations}")</strong></li>
								@if (!isExternal)
								{
									<li><i class="bi bi-broadcast@(showLiveResults ? "" : "-off")"></i> Live-resultat: <strong>@(showLiveResults ? "Ja" : "Nej")</strong></li>
								}
							</ul>
						</div>
					</div>
				</div>
			</div>

			@* ======================================== INTERNAL COMPETITION ONLY: Contact Information ======================================== *@
			@if (!isExternal)
			{
				<div class="card mb-4">
					<div class="card-header">
						<h3 class="card-title h5 mb-0">Kontaktinformation</h3>
					</div>
					<div class="card-body">
						<div class="row">
							<div class="col-md-4">
								<p><strong>T√§vlingsledare:</strong></p>
								<p>@competitionDirector</p>
							</div>
							<div class="col-md-4">
								<p><strong>E-post:</strong></p>
								<p><a href="mailto:@contactEmail">@contactEmail</a></p>
							</div>
							<div class="col-md-4">
								<p><strong>Telefon:</strong></p>
								<p><a href="tel:@contactPhone">@contactPhone</a></p>
							</div>
						</div>

						@if (managerIds.Any())
						{
							<div class="row mt-3">
								<div class="col-12">
									<p><strong>T√§vlingsansvariga:</strong></p>
									<div class="d-flex flex-wrap gap-2">
										@foreach (var managerId in managerIds)
										{
											var manager = MemberService.GetById(managerId);
											if (manager != null)
											{
												var managerEmail = manager.GetValue<string>("email") ?? manager.Email;
												<div class="badge bg-primary d-flex align-items-center">
													<i class="bi bi-person-gear me-1"></i>
													@if (!string.IsNullOrEmpty(managerEmail))
													{
														<a href="mailto:@managerEmail" class="text-white text-decoration-none">@manager.Name</a>
													}
													else
													{
														<span>@manager.Name</span>
													}
												</div>
											}
											else
											{
												@* Show ID if member not found (debugging aid) *@
												<div class="badge bg-secondary d-flex align-items-center">
													<i class="bi bi-person-gear me-1"></i>
													<span>Medlem-ID: @managerId (hittades inte)</span>
												</div>
											}
										}
									</div>
								</div>
							</div>
						}
					</div>
				</div>
			}

			@* Beskrivning Card *@
			@if (!string.IsNullOrWhiteSpace(description))
			{
				<div class="card mb-4">
					<div class="card-header">
						<h3 class="card-title h5 mb-0"><i class="bi bi-text-paragraph me-2"></i>Beskrivning</h3>
					</div>
					<div class="card-body">
						@Html.Raw(description)
					</div>
				</div>
			}

			@* ======================================== Invitation File Display (Both Internal & External) ======================================== *@
			@if (hasInvitation && invitationFile != null)
			{
				<div class="card mb-4">
					<div class="card-header" style="background-color: var(--bs-tertiary-bg);">
						<h3 class="card-title h5 mb-0">
							<i class="bi bi-file-earmark-pdf me-2"></i>Inbjudan
							@if (isExternal)
							{
								<span class="badge bg-info ms-2">Extern t√§vling</span>
							}
						</h3>
					</div>
					<div class="card-body">
						<div class="mb-3">
							<a href="@invitationFile.Url()" class="btn btn-primary" target="_blank" download>
								<i class="bi bi-download me-1"></i>Ladda ner inbjudan
							</a>
							<small class="text-muted ms-2">@invitationFile.Name</small>
						</div>
						@if (invitationFile.Url().EndsWith(".pdf", StringComparison.OrdinalIgnoreCase))
						{
							<div class="ratio ratio-4x3" style="min-height: 600px;">
								<iframe src="@invitationFile.Url()"
										frameborder="0"
										style="border: 1px solid #ddd; border-radius: 4px;"
										title="T√§vlingsinbjudan">
								</iframe>
							</div>
							<p class="text-muted small mt-2">
								<i class="bi bi-info-circle"></i> PDF-f√∂rhandsgranskning. Om den inte visas korrekt, ladda ner filen ovan.
							</p>
						}
						else
						{
							<div class="alert alert-info">
								<i class="bi bi-file-earmark-word me-1"></i>
								Dokumentet √§r inte en PDF-fil och kan inte f√∂rhandsgranskas. Klicka p√• "Ladda ner inbjudan" ovan.
							</div>
						}
					</div>
				</div>
			}

		</div>

		@* ======================================== INTERNAL COMPETITION ONLY: Information Sidebar ======================================== *@
		@if (!isExternal)
		{
			<div class="col-lg-4">
				<div class="card information-sidebar">
					<div class="card-header">
						<h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Information</h5>
					</div>
					<div class="card-body">
					@{
						// Calculate days remaining
						var daysRemaining = (competitionDate.Date - now.Date).Days;
						string daysText;
						string daysBadgeClass;

						if (daysRemaining < 0)
						{
							daysText = $"{Math.Abs(daysRemaining)} dagar sedan";
							daysBadgeClass = "bg-secondary";
						}
						else if (daysRemaining == 0)
						{
							daysText = "Idag!";
							daysBadgeClass = "bg-success";
						}
						else if (daysRemaining == 1)
						{
							daysText = "Imorgon";
							daysBadgeClass = "bg-warning";
						}
						else if (daysRemaining <= 7)
						{
							daysText = $"{daysRemaining} dagar";
							daysBadgeClass = "bg-warning";
						}
						else
						{
							daysText = $"{daysRemaining} dagar";
							daysBadgeClass = "bg-danger";
						}

						// Calculate "Senast uppdaterad" from Model.UpdateDate
						var updateDate = Model.UpdateDate;
						var timeSinceUpdate = DateTime.Now - updateDate;
						string updateText;
						if (timeSinceUpdate.TotalMinutes < 1)
						{
							updateText = "Just nu";
						}
						else if (timeSinceUpdate.TotalHours < 1)
						{
							updateText = $"{(int)timeSinceUpdate.TotalMinutes} minuter sedan";
						}
						else if (timeSinceUpdate.TotalHours < 24)
						{
							updateText = $"{(int)timeSinceUpdate.TotalHours} timmar sedan";
						}
						else
						{
							updateText = updateDate.ToString("yyyy-MM-dd HH:mm");
						}

						// Button visibility logic
						var showStartListPending = now <= registrationCloseDate;
						var competitionCompleted = now.Date > competitionDate.Date;
						var competitionOngoing = now.Date == competitionDate.Date || (now > registrationCloseDate && now.Date <= competitionDate.Date);
						var showResultsPending = now.Date < competitionDate.Date;
					}

					<!-- Antal skyttar -->
					<div class="mb-3">
						<div class="d-flex justify-content-between align-items-center">
							<span><i class="bi bi-people me-1 text-primary"></i> Antal skyttar:</span>
							<span class="badge bg-primary" id="totalShooters">Laddar...</span>
						</div>
					</div>

					<!-- Antal starter -->
					<div class="mb-3">
						<div class="d-flex justify-content-between align-items-center">
							<span><i class="bi bi-flag me-1 text-info"></i> Antal starter:</span>
							<span class="badge bg-info" id="totalStarts">Laddar...</span>
						</div>
					</div>

					<!-- Dagar till t√§vling -->
					<div class="mb-3">
						<div class="d-flex justify-content-between align-items-center">
							<span><i class="bi bi-calendar-event me-1 text-danger"></i> Dagar till t√§vling:</span>
							<span class="badge @daysBadgeClass">@daysText</span>
						</div>
					</div>

					<!-- Senast uppdaterad -->
					<div class="mb-3">
						<div class="d-flex justify-content-between align-items-center">
							<span><i class="bi bi-clock-history me-1 text-secondary"></i> Senast uppdaterad:</span>
							<span class="badge bg-secondary">@updateText</span>
						</div>
					</div>

					<hr>

					@{
						// Build URL for results (start list URL comes from API)
						var competitionUrl = Model.Url();
						var resultsUrl = competitionUrl.TrimEnd('/') + "/resultat/";
					}

					@if (!isExternal)
					{
						<!-- Registered Shooters Button -->
						<div class="mb-2">
							<button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#registeredShootersModal">
								<i class="bi bi-people-fill me-1"></i> Visa anm√§lda skyttar
							</button>
						</div>

						<!-- Start List Section -->
						<div class="mb-2" id="startListSection">
							<a href="#" class="btn btn-info w-100 d-none" id="startListButton" target="_blank">
								<i class="bi bi-list-ol me-1"></i> Visa startlista
							</a>
							<p class="text-muted small mb-0" id="noStartListText">
								<i class="bi bi-hourglass-split me-1"></i> Startlista har inte publicerats √§n.
							</p>
						</div>

						<!-- Results Section -->
						<div class="mt-2" id="resultsSection">
							<a href="@resultsUrl" class="btn btn-warning w-100 d-none" id="resultsButton" target="_blank">
								<i class="bi bi-trophy me-1"></i> Visa resultat
							</a>
							<a href="@resultsUrl" class="btn btn-success w-100 d-none" id="liveResultsButton" target="_blank">
								<i class="bi bi-broadcast me-1"></i> Visa live-resultat
							</a>
							<p class="text-muted small mb-0" id="noResultsText">
								<i class="bi bi-hourglass-split me-1"></i> Resultat har inte publicerats √§n.
							</p>
						</div>
					}
					else
					{
						<!-- External Competition - Show external registration options -->
						@if (!string.IsNullOrEmpty(externalUrl))
						{
							<div class="mb-2">
								<a href="@externalUrl" target="_blank" class="btn btn-info w-100">
									<i class="bi bi-box-arrow-up-right me-1"></i>Extern l√§nk
								</a>
							</div>
						}
						@if (!string.IsNullOrEmpty(externalRegistrationEmail))
						{
							<div class="mb-2">
								<a href="mailto:@externalRegistrationEmail?subject=Anm√§lan till @competitionName" class="btn btn-success w-100">
									<i class="bi bi-envelope me-1"></i>Anm√§l via mejl
								</a>
							</div>
						}
					}
				</div>
			</div>
			</div>
		}

	</div>
</div>


@* Registration Modal (hidden for external competitions) *@
@if (!isExternal)
{
	@await Html.PartialAsync("CompetitionRegistrationModal", new ViewDataDictionary(ViewData)
	{
		{ "CompetitionId", Model.Id },
		{ "CompetitionName", competitionName },
		{ "AClasses", aClasses },
		{ "BClasses", bClasses },
		{ "CClasses", cClasses },
		{ "CRegularClasses", cRegularClasses },
		{ "CVetClasses", cVetClasses },
		{ "CJuniorClasses", cJuniorClasses },
		{ "CDamClasses", cDamClasses },
		{ "RClasses", rClasses },
		{ "LClasses", lClasses },
		{ "LRegularClasses", lRegularClasses },
		{ "LVetClasses", lVetClasses },
		{ "LJuniorClasses", lJuniorClasses },
		{ "LDamClasses", lDamClasses },
		{ "MClasses", mClasses },
		{ "AllowDualCClassRegistration", allowDualCClassRegistration }
	})


	@* Preference Modal *@
	@await Html.PartialAsync("CompetitionPreferenceModal")

	@* Update Confirmation Modal *@
	@await Html.PartialAsync("CompetitionUpdateConfirmModal")

	@* Replace Confirmation Modal *@
	@await Html.PartialAsync("CompetitionReplaceConfirmModal")
}

@* JavaScript Configuration and Script Reference *@
@{
    var swishNumber = Model.Value<string>("swishNumber");
    var hasSwishNumberValue = !string.IsNullOrWhiteSpace(swishNumber);
}
@* DEBUG: swishNumber = "@swishNumber", hasSwishNumber = @hasSwishNumberValue *@
<script>
// Configuration object for competition-registration.js
window.CompetitionConfig = {
    competitionId: @Model.Id,
    allowDualCClassRegistration: @(allowDualCClassRegistration.ToString().ToLower()),
    registrationFee: @(Model.Value<decimal?>("registrationFee") ?? 0),
    hasSwishNumber: @(hasSwishNumberValue.ToString().ToLower())
};

// Show success/error messages from server
@if (TempData["Success"] != null)
{
    var successMsg = TempData["Success"].ToString();
    var jsEncodedMsg = System.Text.Encodings.Web.JavaScriptEncoder.Default.Encode(successMsg);
    <text>
    showNotification('@Html.Raw(jsEncodedMsg)', 'success');

    // Show payment prompt for self-registrations only (not admin registering someone else)
    var msg = '@Html.Raw(jsEncodedMsg)';
    if (msg.indexOf('anm√§lt dig') !== -1) {
        setTimeout(function() {
            showPaymentPrompt(@Model.Id);
        }, 1000);
    }
    </text>
}

@if (TempData["Error"] != null)
{
    <text>
    showNotification('@TempData["Error"]', 'error');
    </text>
}

@if (TempData["DebugInfo"] != null)
{
    <text>
    console.log('Registration Debug Info: @TempData["DebugInfo"]');
    showNotification('DEBUG: @TempData["DebugInfo"]', 'info');
    </text>
}
</script>

@* Registered Shooters Modal *@
<div class="modal fade" id="registeredShootersModal" tabindex="-1" aria-labelledby="registeredShootersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="registeredShootersModalLabel">
                    <i class="bi bi-people-fill me-2"></i>Anm√§lda skyttar
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="registeredShootersModalBody">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Laddar...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> St√§ng
                </button>
            </div>
        </div>
    </div>
</div>

@* Swish Payment Modal *@
<div class="modal fade" id="swishPaymentModal" tabindex="-1" aria-labelledby="swishPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="swishPaymentModalLabel">
                    <i class="bi bi-qr-code"></i> Betala med Swish
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center" id="swishPaymentModalBody">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Laddar QR-kod...</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> St√§ng
                </button>
            </div>
        </div>
    </div>
</div>

@* Load external JavaScript file *@
<script src="/js/competition-registration.js?v=@DateTime.Now.Ticks"></script>

@* Styles for Information Sidebar *@
<style>
/* Desktop: sticky sidebar */
@@media (min-width: 992px) {
    .information-sidebar {
        position: sticky;
        top: 20px;
    }
}

/* Card styling */
.information-sidebar .card-header {
    background-color: var(--bs-secondary-bg);
}

.information-sidebar hr {
    margin: 1rem 0;
    opacity: 0.1;
}

/* User highlighting in registered shooters modal */
#registeredShootersModal .table tr.current-user,
#registeredShootersModal .table tr.current-user td {
    background-color: var(--bs-primary-bg-subtle) !important; /* Primary highlight for current user */
}
#registeredShootersModal .table tr.same-club,
#registeredShootersModal .table tr.same-club td {
    background-color: var(--bs-info-bg-subtle) !important; /* Secondary highlight for same club */
}
</style>

@* JavaScript for Information Sidebar *@
<script>
// Current user information for highlighting
const currentUserName = '@Html.Raw(currentMemberName.Replace("'", "\\'"))';
const currentUserClub = '@Html.Raw(currentMemberClub.Replace("'", "\\'"))';

document.addEventListener('DOMContentLoaded', function() {
    const competitionId = @Model.Id;

    // Fetch registration count
    fetch(`/umbraco/surface/Competition/GetCompetitionRegistrations?competitionId=${competitionId}`)
        .then(response => response.json())
        .then(data => {
            const shootersEl = document.getElementById('totalShooters');
            const startsEl = document.getElementById('totalStarts');

            if (data.statistics) {
                // Use statistics from API (already calculated correctly)
                const uniqueShooters = data.statistics.uniqueMembers || 0;
                const totalStarts = data.statistics.totalRegistrations || 0;  // Total class entries (starts)

                if (shootersEl) shootersEl.textContent = uniqueShooters;
                if (startsEl) startsEl.textContent = totalStarts;
            } else if (data.registrations) {
                // Fallback: calculate from registrations if statistics not available
                const uniqueShooters = new Set(data.registrations.map(r => r.memberId)).size;

                // Count total class entries across all registrations
                const totalStarts = data.registrations.reduce((sum, r) => {
                    return sum + (r.shootingClasses ? r.shootingClasses.length : 0);
                }, 0);

                if (shootersEl) shootersEl.textContent = uniqueShooters;
                if (startsEl) startsEl.textContent = totalStarts;
            } else {
                if (shootersEl) shootersEl.textContent = '0';
                if (startsEl) startsEl.textContent = '0';
            }
        })
        .catch(error => {
            console.error('Error fetching registrations:', error);
            const shootersEl = document.getElementById('totalShooters');
            const startsEl = document.getElementById('totalStarts');
            if (shootersEl) shootersEl.textContent = '-';
            if (startsEl) startsEl.textContent = '-';
        });

    // Check if published start list exists via API
    const startListButton = document.getElementById('startListButton');
    const noStartListText = document.getElementById('noStartListText');

    if (startListButton && noStartListText) {
        fetch(`/umbraco/surface/PrecisionStartList/GetOfficialStartList?competitionId=${competitionId}`)
            .then(response => response.json())
            .then(data => {
                // Check if start list exists and is published (isOfficialStartList = true)
                if (data.success && data.startList) {
                    const isOfficial = data.startList.IsOfficial || data.startList.isOfficial || data.startList.isOfficialStartList;
                    const startListUrl = data.startList.Url || data.startList.url;
                    if (isOfficial && startListUrl) {
                        // Published start list exists - show button with actual URL from API
                        startListButton.href = startListUrl;
                        startListButton.classList.remove('d-none');
                        noStartListText.classList.add('d-none');
                    } else {
                        // Start list exists but not published yet
                        startListButton.classList.add('d-none');
                        noStartListText.classList.remove('d-none');
                    }
                } else {
                    // No start list - show text
                    startListButton.classList.add('d-none');
                    noStartListText.classList.remove('d-none');
                }
            })
            .catch(error => {
                console.error('Error checking start list:', error);
                // On error, keep showing "not published" text
                startListButton.classList.add('d-none');
                noStartListText.classList.remove('d-none');
            });
    }

    // Check if published results exist via API
    const resultsButton = document.getElementById('resultsButton');
    const liveResultsButton = document.getElementById('liveResultsButton');
    const noResultsText = document.getElementById('noResultsText');

    if (resultsButton && noResultsText) {
        fetch(`/umbraco/surface/CompetitionResults/GetResultsList?competitionId=${competitionId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.exists) {
                    const isOfficial = data.isOfficial || data.IsOfficial;
                    if (isOfficial) {
                        // Official results - show results button
                        resultsButton.classList.remove('d-none');
                        liveResultsButton.classList.add('d-none');
                        noResultsText.classList.add('d-none');
                    } else {
                        // Preliminary results - show live results button
                        liveResultsButton.classList.remove('d-none');
                        resultsButton.classList.add('d-none');
                        noResultsText.classList.add('d-none');
                    }
                } else {
                    // No results - show text
                    resultsButton.classList.add('d-none');
                    liveResultsButton.classList.add('d-none');
                    noResultsText.classList.remove('d-none');
                }
            })
            .catch(error => {
                console.error('Error checking results:', error);
                // On error, keep showing "not published" text
                resultsButton.classList.add('d-none');
                liveResultsButton.classList.add('d-none');
                noResultsText.classList.remove('d-none');
            });
    }

    // Handle registered shooters modal
    const registeredShootersModal = document.getElementById('registeredShootersModal');
    if (registeredShootersModal) {
        registeredShootersModal.addEventListener('show.bs.modal', function () {
            const modalBody = document.getElementById('registeredShootersModalBody');
            modalBody.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Laddar...</span></div></div>';

            fetch(`/umbraco/surface/Competition/GetCompetitionRegistrations?competitionId=${competitionId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.registrations && data.registrations.length > 0) {
                        // Group by shooter (memberId and memberName)
                        const shooterMap = new Map();
                        data.registrations.forEach(reg => {
                            const key = reg.memberId;
                            if (!shooterMap.has(key)) {
                                shooterMap.set(key, {
                                    name: reg.memberName,
                                    club: reg.memberClub || 'Ok√§nd klubb',
                                    classes: []
                                });
                            }

                            // Add all shooting classes from this registration's shootingClasses array
                            if (reg.shootingClasses && Array.isArray(reg.shootingClasses)) {
                                reg.shootingClasses.forEach(sc => {
                                    // Use className for display (e.g., "C Vet √Ñ")
                                    shooterMap.get(key).classes.push(sc.className || sc.class);
                                });
                            }
                        });

                        // Build HTML
                        let html = '<div class="table-responsive"><table class="table table-hover"><thead><tr><th>Namn</th><th>F√∂rening</th><th>Klasser</th></tr></thead><tbody>';

                        // Sort by name
                        const shooters = Array.from(shooterMap.values()).sort((a, b) => a.name.localeCompare(b.name));

                        shooters.forEach(shooter => {
                            // Determine row class for highlighting
                            let rowClass = '';
                            if (currentUserName && shooter.name === currentUserName) {
                                rowClass = 'current-user';
                            } else if (currentUserClub && shooter.club === currentUserClub) {
                                rowClass = 'same-club';
                            }

                            html += `<tr class="${rowClass}">
                                <td>${shooter.name}</td>
                                <td>${shooter.club}</td>
                                <td>${shooter.classes.join(', ')}</td>
                            </tr>`;
                        });

                        html += '</tbody></table></div>';

                        // Calculate total starts (sum of all class entries)
                        const totalStarts = Array.from(shooterMap.values()).reduce((sum, shooter) => sum + shooter.classes.length, 0);
                        html += `<p class="text-muted small mt-2 mb-0"><i class="bi bi-info-circle me-1"></i>${shooters.length} skyttar, ${totalStarts} starter totalt</p>`;

                        modalBody.innerHTML = html;
                    } else {
                        modalBody.innerHTML = '<p class="text-center text-muted">Inga anm√§lda skyttar √§n.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching registered shooters:', error);
                    modalBody.innerHTML = '<p class="text-center text-danger">Kunde inte ladda anm√§lda skyttar.</p>';
                });
        });
    }
});
</script>
